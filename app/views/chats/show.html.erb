<% content_for :title, @chat.title %>

<%= turbo_stream_from @chat %>

<div class="mb-6 flex items-center justify-between">
  <h1 class="text-2xl font-semibold"><%= @chat.title %></h1>
  
  <div class="flex items-center gap-2">
    <%= link_to chats_path, class: "py-2 px-4 bg-gray-100 text-gray-700 rounded-lg text-sm font-medium" do %>
      All Chats
    <% end %>
    
    <%= button_to chat_path(@chat), method: :delete, class: "p-2 rounded-lg bg-gray-100 text-gray-700 hover:bg-gray-200", data: { turbo_confirm: "Are you sure you want to delete this chat?" } do %>
      <%= icon("trash-2") %>
    <% end %>
  </div>
</div>

<div class="bg-white border border-gray-200 rounded-lg overflow-hidden">
  <div class="h-[500px] overflow-y-auto" id="chat-container">
    <div id="messages" class="space-y-4 p-4">
      <% messages = @messages.where(internal: [false, nil]) %>
      <% if messages.any? %>
        <% messages.each do |message| %>
          <%= render "messages/message", message: message %>
        <% end %>
      <% else %>
        <!-- Show welcome message when chat has no messages -->
        <div class="flex items-start gap-3 mb-4">
          <div class="w-10 h-10 bg-gradient-to-br from-purple-400 to-pink-500 rounded-full flex items-center justify-center flex-shrink-0 text-white">
            <%= icon("bot") %>
          </div>
          <div class="bg-gray-100 text-gray-800 rounded-lg p-4 max-w-[85%]">
            <p>Hey <%= Current.user&.first_name || 'there' %>! I'm an AI built by Maybe to help with your finances. How can I assist you today?</p>
          </div>
        </div>
      <% end %>
    </div>
  </div>

  <div class="border-t border-gray-200 p-4">
    <%= form_with model: [@chat, @message], class: "relative", data: { controller: "message-form", action: "turbo:submit-end->message-form#reset" } do |f| %>
      <div class="bg-white border border-gray-300 rounded-lg overflow-hidden">
        <div class="px-3 py-2">
          <%= f.text_area :content, 
              placeholder: "Ask anything...", 
              class: "w-full border-0 focus:ring-0 resize-none text-sm",
              rows: 1,
              data: { 
                controller: "textarea-autogrow",
                action: "input->textarea-autogrow#resize keydown->message-form#checkSubmit"
              } %>
        </div>
        
        <div class="flex items-center px-2 py-2 border-t border-gray-200">
          <button type="button" class="p-1.5 text-gray-500 hover:text-gray-700 rounded-md">
            <%= icon("plus") %>
          </button>
          <button type="button" class="p-1.5 text-gray-500 hover:text-gray-700 rounded-md">
            <%= icon("command") %>
          </button>
          <button type="button" class="p-1.5 text-gray-500 hover:text-gray-700 rounded-md">
            <%= icon("at-sign") %>
          </button>
          <button type="button" class="p-1.5 text-gray-500 hover:text-gray-700 rounded-md">
            <%= icon("sparkles") %>
          </button>
          
          <button type="submit" class="ml-auto p-1.5 text-gray-500 hover:text-gray-700 rounded-md" data-message-form-target="submit">
            <%= icon("arrow-up") %>
          </button>
        </div>
      </div>
    <% end %>
  </div>
</div>

<script>
  document.addEventListener('turbo:load', function() {
    const chatContainer = document.getElementById('chat-container');
    if (chatContainer) {
      chatContainer.scrollTop = chatContainer.scrollHeight;
    }
  });
</script> 