<%= render "layouts/shared/htmldoc" do %>
  <div class="flex h-full bg-gray-50" data-controller="sidebar" data-sidebar-user-id-value="<%= Current.user.id %>">
    <nav class="flex flex-col shrink-0 w-[84px] py-4 mr-3">
      <div class="pl-2 mb-3">
        <%= link_to root_path, class: "block" do %>
          <%= image_tag "logomark-color.svg", class: "w-9 h-9 mx-auto" %>
        <% end %>
      </div>

      <ul class="space-y-0.5">
        <li>
          <%= render "layouts/sidebar/nav_item", name: "Home", path: root_path, icon_key: "pie-chart" %>
        </li>

        <li>
          <%= render "layouts/sidebar/nav_item", name: "Transactions", path: transactions_path, icon_key: "credit-card" %>
        </li>

        <li>
          <%= render "layouts/sidebar/nav_item", name: "Budgets", path: budgets_path, icon_key: "map" %>
        </li>
      </ul>

      <div class="pl-2 mt-auto mx-auto">
        <%= render "users/user_menu", user: Current.user %>
      </div>
    </nav>

    <%= tag.div class: class_names("py-4 shrink-0 h-full overflow-y-auto transition-all duration-300", Current.user.show_sidebar? ? "w-80" : "w-0"), data: { sidebar_target: "leftPanel" } do %>
      <% if content_for?(:sidebar) %>
        <%= yield :sidebar %>
      <% else %>
        <div id="account-sidebar-tabs" data-turbo-permanent>
          <%= render "accounts/account_sidebar_tabs", family: Current.family %>
        </div>
      <% end %>
    <% end %>

    <% 
      left_sidebar_open = Current.user.show_sidebar?
      right_sidebar_open = (Current.user.respond_to?(:show_ai_sidebar?) && Current.user.show_ai_sidebar?) || @chat.present?
      content_width_class = if left_sidebar_open && right_sidebar_open
                              "max-w-3xl"
                            elsif left_sidebar_open || right_sidebar_open
                              "max-w-4xl"
                            else
                              "max-w-5xl"
                            end
    %>

    <%= tag.main class: class_names("px-10 py-4 grow h-full", require_upgrade? ? "relative overflow-hidden" : "overflow-y-auto") do %>
      <% if require_upgrade? %>
        <div class="absolute inset-0 px-10 h-full w-full z-50">
          <%= render "shared/subscribe_modal" %>
        </div>
      <% end %>

      <%= tag.div class: class_names("mx-auto w-full h-full", content_width_class), data: { sidebar_target: "content" } do %>
        <% if content_for?(:breadcrumbs) %>
          <%= yield :breadcrumbs %>
        <% else %>
          <%= render "layouts/shared/breadcrumbs", breadcrumbs: @breadcrumbs %>
        <% end %>

        <% if content_for?(:page_header) %>
          <%= yield :page_header %>
        <% end %>

        <%= yield %>
      <% end %>
    <% end %>

    <%= tag.div class: class_names("py-4 shrink-0 h-full overflow-y-auto transition-all duration-300", right_sidebar_open ? "w-[375px]" : "w-0"), data: { sidebar_target: "rightPanel" } do %>
      <%= render "layouts/shared/ai_sidebar" %>

      <% if Current.user.show_ai_sidebar? %>
        <div data-controller="ai-chat" class="my-4 flex flex-col h-full max-h-[calc(100vh-128px)]">
          <div id="thinking" class="hidden"></div>
          <div data-ai-chat-target="chatWindow" class="flex-1 overflow-y-auto overflow-x-hidden min-h-24 px-4 pb-8">
            <%= render "layouts/shared/ai_greeting" %>
          </div>
          <div class="pt-2 border-t border-gray-100 dark:border-gray-800 max-w-full px-4">
            <form data-action="ai-chat#sendMessage" class="relative">
              <textarea 
                data-ai-chat-target="input" 
                data-action="keydown->ai-chat#handleKeyDown" 
                class="resize-none rounded-md w-full px-3 py-2 border border-gray-200 dark:border-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-800" 
                placeholder="Ask about your finances..." 
                rows="1"
              ></textarea>
              <button 
                type="submit" 
                class="absolute right-3 bottom-2 text-gray-400 dark:text-gray-500 hover:text-gray-600 dark:hover:text-gray-300" 
                data-ai-chat-target="submitButton"
              >
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="h-5 w-5 transform rotate-90">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
                </svg>
              </button>
            </form>
          </div>
        </div>
      <% end %>
    <% end %>
  </div>
<% end %>
